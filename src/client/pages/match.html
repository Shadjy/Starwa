<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Vacature Matching Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/global.css" />
  <link rel="stylesheet" href="../css/match.css" />
</head>

<body>
  <header class="main-header">
    <div class="logo">Starwa</div>
    <div class="header-actions">
      <a href="/home" class="logout">
        <img src="../assests/icons/logout.png" alt="Logout" class="logout-logo">
        <span class="logout-text">Log uit</span>
      </a>
    </div>
  </header>

  <main class="page">
    <div class="grid">
      <!--Sidebar filters (blijft vast) -->
      <aside class="panel sidebar">
        <form id="matchForm">
          <label class="label-row">
            <span>Functie</span>
            <button type="button" class="info-btn" data-info="functie" aria-label="Info functie">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="functie">
            <option>Data Analist</option>
            <option>Developer</option>
            <option>Project Manager</option>
          </select>

          <!-- Locatie -->
          <label class="label-row">
            <span>Locatie</span>
            <button type="button" class="info-btn" data-info="locatie" aria-label="Info locatie">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="locatie">
            <option>Utrecht</option>
            <option>Amsterdam</option>
            <option>Rotterdam</option>
          </select>

          <!-- Uren per week -->
          <label class="label-row">
            <span>Uren per week</span>
            <button type="button" class="info-btn" data-info="uren" aria-label="Info uren per week">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="uren">
            <option>16</option><option>24</option><option>32</option><option>36</option><option selected>40</option>
          </select>

          <!-- Sector -->
          <label class="label-row">
            <span>Sector</span>
            <button type="button" class="info-btn" data-info="sector" aria-label="Info sector">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="sector">
            <option>Alle</option>
            <option>Finance</option>
            <option>HealthTech</option>
            <option>Duurzaamheid</option>
          </select>

          <!-- Contracttype -->
          <label class="label-row">
            <span>Contracttype</span>
            <button type="button" class="info-btn" data-info="contract" aria-label="Info contracttype">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="contract">
            <option>Alle</option>
            <option>Fulltime</option>
            <option>Parttime</option>
          </select>

          <!-- Urgentie -->
          <label class="label-row">
            <span>Urgentie</span>
            <button type="button" class="info-btn" data-info="urgentie" aria-label="Info urgentie">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="urgentie">
            <option>Alle</option>
            <option>Laag</option>
            <option>Normaal</option>
            <option>Hoog</option>
          </select>

          <!-- Reiskostenvergoeding -->
          <label class="label-row">
            <span>Reiskostenvergoeding</span>
            <button type="button" class="info-btn" data-info="reiskosten" aria-label="Info reiskostenvergoeding">
              <svg viewBox="0 0 24 24" class="info-icon" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <circle cx="12" cy="7.5" r="1.2" fill="currentColor"/>
                <rect x="11" y="10" width="2" height="7" rx="1" fill="currentColor"/>
              </svg>
            </button>
          </label>
          <select id="reiskosten">
            <option>Alle</option>
            <option>Ja</option>
            <option>Nee</option>
          </select>

          <div class="btn-row">
            <button type="submit">Bereken matches</button>
            <button type="button" id="btnReset" class="button">Reset</button>
          </div>
        </form>

        <div class="fav-panel">
          <a href="../pages/favorieten-vacatures.html">
            <span>Favorieten</span>
            <span class="fav-chip"><span id="favCountJobs">0</span></span>
          </a>
        </div>
      </aside>

      <!-- Resultaten -->
      <section class="results" aria-label="Resultaten">
        <div class="results-head">
          <h1>Matching vacatures</h1>
          <div class="results-sub" id="resultsSub">Toont vacatures (live of demo)</div>
        </div>

        <div id="results" class="list"></div>
      </section>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" hidden>
      <div class="modal__backdrop" data-close></div>
      <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal__header">
          <h3 id="modalTitle" style="margin:.25rem 0">Meer info</h3>
          <button class="modal__close" data-close aria-label="Sluiten">×</button>
        </div>
        <div id="modalBody" class="modal__body"></div>
      </div>
    </div>
  </main>

  <!-- Data ophalen -->
  <script src="../data/match.data.js" defer></script>

  <!-- gedrag (render + favorieten + modals) + live vacatures -->
  <script defer>
    // API base: same origin on :3000; else point to backend on :3000
    const API_BASE = (typeof window !== 'undefined' && window.STARWA_API_BASE)
      ? window.STARWA_API_BASE
      : (location.port === '3000' ? '' : `${location.protocol}//${location.hostname}:3000`);

    const resultsEl = document.getElementById("results");
    const form = document.getElementById("matchForm");
    const btnReset = document.getElementById("btnReset");
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modalBody");
    const favCountEl = document.getElementById("favCountJobs");
    const resultsSub = document.getElementById("resultsSub");

    const fmt = s => String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    function openModal(html){
      modalBody.innerHTML = html;
      modal.hidden = false;
      modal.classList.add("active");
      document.body.classList.add("no-scroll");
    }
    function closeModal(){
      modal.classList.remove("active");
      modal.hidden = true;
      modalBody.innerHTML = "";
      document.body.classList.remove("no-scroll");
    }
    modal.addEventListener("click",(e)=>{ if (e.target.dataset.close !== undefined || e.target.classList.contains("modal__backdrop")) closeModal(); });
    window.addEventListener("keydown",(e)=>{ if(e.key === "Escape" && !modal.hidden) closeModal(); });

    /* Info-popover inhoud */
    const filterInfo = {
      functie:{ weight:30, reason:"Functie bepaalt of de vaardigheden aansluiten. Daarom weegt dit het zwaarst." },
      locatie:{ weight:20, reason:"Locatie is belangrijk voor reistijd/beschikbaarheid." },
      uren:{ weight:20, reason:"Uren bepalen of de contractomvang matcht." },
      sector:{ weight:10, reason:"Sector geeft domeinkennis/context." },
      contract:{ weight:10, reason:"Gewenst contract (fulltime/parttime) moet aansluiten." },
      urgentie:{ weight:5, reason:"Urgentie helpt prioriteren, maar is niet doorslaggevend." },
      reiskosten:{ weight:5, reason:"Reiskostenvergoeding is prettig, maar weegt het minst." }
    };
    document.querySelectorAll(".info-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.dataset.info || "filter";
        const info = filterInfo[key] || {weight:"—",reason:"—"};
        openModal(`<h3 style="margin:.25rem 0 .5rem">Informatie over filter: ${key}</h3>
          <p><strong>Weging:</strong> ${info.weight}</p>
          <p>${info.reason}</p>`);
      });
    });

    /* Waarom: alleen ✔ of ☐ */
    function liWithIcon(text){
      const cleaned = String(text||"").replace(/^(?:[\s•●○◦▪▫◻☐✅✔✖✗–—\-]+)+/,'').trim();
      const isOk = /matcht|exact|overeen/i.test(cleaned) && !/anders|wijkt/i.test(cleaned);
      return `<li class="${isOk?'why-ok':''}">${fmt(cleaned)}</li>`;
    }

    /* Favorieten (localStorage) */
    const getFavs = () => { try { return JSON.parse(localStorage.getItem("favorites")||"[]"); } catch { return []; } };
    const setFavs = (a) => localStorage.setItem("favorites", JSON.stringify(a));
    const favKey = (type, srcId) => `${type}:${srcId}`;
    function isFav(type, srcId){ return getFavs().some(f => (f.type===type) && (f.srcId===srcId)); }
    function toggleFav(type, srcId, payload){
      let favs = getFavs();
      const key = favKey(type, srcId);
      if (isFav(type, srcId)){
        favs = favs.filter(f => favKey(f.type,f.srcId)!==key);
      } else {
        favs.push({ type, id:key, srcId, data:payload });
      }
      setFavs(favs);
      updateFavCount();
    }
    function updateFavCount(){
      const c = getFavs().filter(f=>f.type==='vacature').length;
      if(favCountEl) favCountEl.textContent = c;
    }

    function openApplyModal(v){
      openModal(`
        <form id="applyForm">
          <div class="detail-grid">
            <div>
              <h3>Solliciteren op: ${fmt(v.title)}</h3>
              <p><strong>Bedrijf:</strong> ${fmt(v.company)}</p>
              <label>Naam<br><input required style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:8px"></label>
            </div>
            <div>
              <label>E-mail<br><input type="email" required style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:8px"></label>
              <label style="display:block;margin-top:.5rem">Bericht<br>
                <textarea rows="4" style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:8px"></textarea>
              </label>
            </div>
          </div>
          <div class="modal__footer" style="padding:0;margin-top:.75rem">
            <button type="button" class="modal__close" data-close>Annuleren</button>
            <button type="submit" class="modal__close">Verstuur</button>
          </div>
        </form>
      `);
      document.getElementById("applyForm").addEventListener("submit",(e)=>{
        e.preventDefault();
        openModal(`<h3>Sollicitatie verzonden ✅</h3><p>We hebben je sollicitatie op <strong>${fmt(v.title)}</strong> geregistreerd.</p><div class="modal__footer"><button class="modal__close" data-close>Sluiten</button></div>`);
      });
    }

    function render(matches){
      if(!matches || !matches.length){
        resultsEl.innerHTML = `
          <div class="card empty-state">
            <div>
              <div class="empty-title">Geen resultaten</div>
              <div class="empty-text">Pas de filters links aan en klik op “Bereken matches”.</div>
            </div>
          </div>`;
        if(resultsSub) resultsSub.textContent = "Geen resultaten";
        return;
      }

      if(resultsSub) resultsSub.textContent = `${matches.length} vacatures gevonden`;

      resultsEl.innerHTML = matches.map(m=>{
        const saved = isFav("vacature", m.id);
        return `
        <div class="card">
          <div class="title">
            <div>
              <div class="job-title">${fmt(m.title)}</div>
              <div class="meta">${fmt(m.company||'-')} • ${fmt(m.locatie||'-')} • ${fmt(m.uren||'-')}u • ${fmt(m.functie||'-')} • ${fmt(m.sector||'-')} • ${fmt(m.contractType||'-')}</div>
            </div>
            <div class="badge">${m.score ?? 0}% match</div>
          </div>

          <div class="why">
            <strong>Waarom deze score:</strong>
            <ul>${(m.why || []).map(liWithIcon).join("")}</ul>
          </div>

          <div class="progress"><div class="bar" style="width:${m.score}%"></div></div>

          <div class="detail-panel" data-detail hidden></div>

          <div class="actions">
            <div class="left">
              <button class="secondary" data-id="${m.id}" data-action="info" type="button">Meer info</button>
            </div>
            <div class="right">
              <button class="primary" data-id="${m.id}" data-action="apply" type="button">Solliciteren</button>
              <button class="fav ${saved?'saved':''}" data-id="${m.id}" data-action="fav" type="button">${saved?'Opgeslagen':'Favoriet'}</button>
            </div>
          </div>
        </div>`;
      }).join("");

      /* binds */
      resultsEl.querySelectorAll('[data-action="info"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          const v = matches.find(x => x.id === id);
          const d = v.details || {};
          const contacts = (d.contacts||[]).map(c=>`<li>${fmt(c.name)} — <a href="mailto:${fmt(c.email)}">${fmt(c.email)}</a></li>`).join("");
          const card = btn.closest(".card");
          const panel = card.querySelector("[data-detail]");
          const isHidden = panel.hasAttribute("hidden");

          if (isHidden) {
            panel.innerHTML = `
              <div class="detail-grid">
                <div><h3>Vacature</h3>
                  <p><strong>${fmt(v.title)}</strong> bij <strong>${fmt(v.company)}</strong></p>
                  <p>${fmt(v.functie)} • ${fmt(v.locatie)} • ${fmt(v.uren)} uur • ${fmt(v.sector)}</p>
                  <p><strong>Contract:</strong> ${fmt(d.contractType||"-")}</p>
                  <p><strong>Salaris:</strong> ${fmt(d.salary||"-")}</p>
                  <p><strong>Urgentie:</strong> ${fmt(d.urgency||"-")}</p>
                </div>
                <div><h3>Bedrijfsfilosofie</h3><p>${fmt(d.philosophy||"—")}</p></div>
                <div><h3>Primaire arbeidsvoorwaarden</h3><ul>${(d.primaryBenefits||[]).map(b=>`<li>${fmt(b)}</li>`).join("") || "<li>—</li>"}</ul></div>
                <div><h3>Secundaire arbeidsvoorwaarden</h3><ul>${(d.secondaryBenefits||[]).map(b=>`<li>${fmt(b)}</li>`).join("") || "<li>—</li>"}</ul></div>
                <div><h3>Reiskostenvergoeding</h3><p>${fmt(d.travelAllowance||"—")}</p></div>
                <div><h3>Contactpersonen</h3><ul>${contacts || "<li>—</li>"}</ul></div>
              </div>`;
            panel.removeAttribute("hidden");
            card.classList.add("detail-open");
            btn.textContent = "Minder info";
          } else {
            panel.setAttribute("hidden", "");
            panel.innerHTML = "";
            card.classList.remove("detail-open");
            btn.textContent = "Meer info";
          }
        });
      });

      resultsEl.querySelectorAll('[data-action="apply"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          openApplyModal(matches.find(x=>x.id===id));
        });
      });

      resultsEl.querySelectorAll('[data-action="fav"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          const v = matches.find(x=>x.id===id);

          toggleFav("vacature", v.id, {
            id:v.id, title:v.title, company:v.company, locatie:v.locatie,
            uren:v.uren, functie:v.functie, sector:v.sector, contractType:v.contractType,
            score:v.score, why:v.why
          });

          const saved = isFav("vacature", v.id);
          btn.classList.toggle('saved', saved);
          btn.textContent = saved ? 'Opgeslagen' : 'Favoriet';
        });
      });
    }

    // Live vacatures ophalen en optionele, simpele scoring toepassen op basis van filters
    let LIVE_VACATURES = [];

    function mapVacancyToMatch(v, filters){
      // veilig mappen (zodat “niet correct tonen” minder snel gebeurt)
      const f = filters || {};
      let score = 0;
      const why = [];

      const fun = (v.functietitel || v.title || '').trim();
      const cat = (v.categorie || v.sector || '').trim();
      const role = fun || cat;

      const loc = (v.locatie || v.location || '').trim();
      const uren = (v.uren_per_week ?? v.hours_per_week ?? v.uren ?? '') !== '' ? String(v.uren_per_week ?? v.hours_per_week ?? v.uren) : '';
      const dienst = (v.dienstverband || v.contractType || '').trim();

      if (f.functie && role && f.functie === role) { score += 20; why.push(`Functie matcht: ${role}`) } else if (f.functie) { why.push(`Functie anders: gezocht '${f.functie}', vacature '${role||"-"}'`) }
      if (f.locatie && loc && f.locatie === loc) { score += 20; why.push(`Locatie matcht: ${loc}`) } else if (f.locatie) { why.push(`Locatie anders: gezocht '${f.locatie}', vacature '${loc||"-"}'`) }
      if (f.uren && uren && f.uren === uren) { score += 20; why.push(`Uren matcht: ${uren}`) } else if (f.uren) { why.push(`Uren anders: gezocht '${f.uren}', vacature '${uren||"-"}'`) }
      if (f.contract && f.contract !== 'Alle' && dienst) {
        if (f.contract === dienst) { score += 10; why.push(`Contract matcht: ${dienst}`) }
        else { why.push(`Contract anders: gezocht '${f.contract}', vacature '${dienst}'`) }
      }

      score = Math.max(0, Math.min(100, score));

      return {
        id: v.id ?? v.vacature_id ?? Math.floor(Math.random()*1e9),
        title: v.functietitel || v.title || 'Vacature',
        company: v.company_name || v.company || '-',
        functie: role || '-',
        locatie: loc || '-',
        uren: uren || '-',
        sector: cat || '-',
        contractType: dienst || '-',
        score,
        why,
        details: {
          salary: (v.salaris_min || v.salaris_max) ? `${v.salaris_min||''} - ${v.salaris_max||''}` : '-',
          contractType: dienst
        }
      };
    }

    async function loadLiveVacancies(){
      try {
        const res = await fetch(`${API_BASE}/api/vacatures?active=1&limit=100`, { credentials: 'include' });
        if (!res.ok) throw new Error('Kon vacatures niet laden');

        const data = await res.json();
        LIVE_VACATURES = Array.isArray(data.items) ? data.items : [];

        const items = LIVE_VACATURES.map(v => mapVacancyToMatch(v, {}));
        render(items);

        if(resultsSub) resultsSub.textContent = `${items.length} vacatures (live)`;
      } catch (err) {
        console.warn('Live vacatures laden mislukt:', err);
        computeAndRenderFromForm(); // fallback mock
        if(resultsSub) resultsSub.textContent = `Demo vacatures (geen live verbinding)`;
      }
    }

    function getFilters(){
      return {
        functie: document.getElementById("functie").value,
        locatie: document.getElementById("locatie").value,
        uren: document.getElementById("uren").value,
        sector: document.getElementById("sector").value,
        contract: document.getElementById("contract").value,
        urgentie: document.getElementById("urgentie").value,
        reiskosten: document.getElementById("reiskosten").value
      };
    }

    function computeAndRenderFromForm(){
      if (LIVE_VACATURES && LIVE_VACATURES.length){
        const f = getFilters();
        const data = LIVE_VACATURES.map(v => mapVacancyToMatch(v, f)).sort((a,b)=>b.score-a.score);
        render(data);
        if(resultsSub) resultsSub.textContent = `${data.length} vacatures (live)`;
        return;
      }
      // fallback op mock dataset (match.data.js)
      const data = computeMatchesForJobs(getFilters());
      render(data);
      if(resultsSub) resultsSub.textContent = `${data.length} vacatures (demo)`;
    }

    function init(){
      updateFavCount();
      loadLiveVacancies();
    }

    form.addEventListener("submit", e=>{ e.preventDefault(); computeAndRenderFromForm(); });

    btnReset.addEventListener("click", ()=>{
      form.reset();
      computeAndRenderFromForm();
    });

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
  